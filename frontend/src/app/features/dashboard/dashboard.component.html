<div class="dashboard-page">
  <app-navbar></app-navbar>

  <div class="dashboard-container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>
          <mat-icon>dashboard</mat-icon>
          Dashboard
        </h1>
        <span class="last-updated" *ngIf="lastUpdated">
          Updated {{ lastUpdated | localDate:'timeOnly' }}
        </span>
      </div>
      <div class="header-actions">
        <button mat-raised-button (click)="goToPipelineBuilder()">
          <mat-icon>add</mat-icon>
          New Pipeline
        </button>
        <button mat-raised-button color="primary" (click)="refresh()">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading-container" *ngIf="loading">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading dashboard...</p>
    </div>

    <!-- Error -->
    <div class="error-card" *ngIf="error && !loading">
      <mat-icon>error_outline</mat-icon>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="refresh()">Retry</button>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content" *ngIf="data && !loading">

      <!-- ─── Section 2: Live Stats Bar (reordered) ──────────── -->
      <div class="stats-row">
        <!-- 1. Active Now -->
        <mat-card class="stat-card stat-card-active">
          <mat-card-content>
            <div class="stat-icon executions-icon">
              <mat-icon>play_circle</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value">{{ data.executions.monitoring + data.executions.running }}</div>
              <div class="stat-label">Active Now</div>
              <div class="stat-sub">
                {{ data.executions.monitoring }} monitoring · {{ data.executions.running }} running
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- 2. Today's P&L -->
        <mat-card class="stat-card" [ngClass]="data.today.pnl >= 0 ? 'stat-card-pnl-up' : 'stat-card-pnl-down'">
          <mat-card-content>
            <div class="stat-icon" [ngClass]="getPnLClass(data.today.pnl)">
              <mat-icon>{{ data.today.pnl >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value" [ngClass]="getPnLClass(data.today.pnl)">
                {{ formatPnL(data.today.pnl) }}
              </div>
              <div class="stat-label">Today's P&L</div>
              <div class="stat-sub" *ngIf="data.today.total_trades > 0">
                {{ data.today.total_trades }} trade{{ data.today.total_trades !== 1 ? 's' : '' }} today
              </div>
              <div class="stat-sub" *ngIf="data.today.total_trades === 0">
                No trades today
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- 3. Total P&L -->
        <mat-card class="stat-card" [ngClass]="data.pnl.total >= 0 ? 'stat-card-pnl-up' : 'stat-card-pnl-down'">
          <mat-card-content>
            <div class="stat-icon" [ngClass]="getPnLClass(data.pnl.total)">
              <mat-icon>{{ data.pnl.total >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value" [ngClass]="getPnLClass(data.pnl.total)">
                {{ formatPnL(data.pnl.total) }}
              </div>
              <div class="stat-label">Total P&L</div>
              <div class="stat-sub">
                Realized: {{ formatPnL(data.pnl.total_realized) }} ·
                Unrealized: {{ formatPnL(data.pnl.total_unrealized) }}
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- 4. Total Cost -->
        <mat-card class="stat-card stat-card-cost">
          <mat-card-content>
            <div class="stat-icon cost-icon">
              <mat-icon>attach_money</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value">{{ formatCost(data.executions.total_cost) }}</div>
              <div class="stat-label">Total Cost</div>
              <div class="stat-sub">
                {{ formatSuccessRate(data.executions.success_rate) }} success rate
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- ─── Section 3: Active Positions (PROMOTED) ────────── -->
      <mat-card class="section-card full-width">
        <mat-card-header>
          <mat-card-title>
            <div class="section-title">
              <mat-icon class="pulse">visibility</mat-icon>
              Active Positions
              <span class="count-badge" *ngIf="data.active_positions.length > 0">
                {{ data.active_positions.length }}
              </span>
            </div>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="positions-grid" *ngIf="data.active_positions.length > 0; else noPositions">
            <div class="position-card" *ngFor="let pos of data.active_positions"
                 (click)="viewPosition(pos)"
                 [ngClass]="getPositionSideClass(pos)">
              <div class="position-header">
                <div class="symbol-section">
                  <div class="symbol-badge">{{ pos.symbol || 'N/A' }}</div>
                  <div class="side-badge" *ngIf="pos.trade_info?.side" [ngClass]="getActionClass(pos.trade_info?.side || null)">
                    {{ pos.trade_info?.side }}
                  </div>
                </div>
                <mat-chip class="status-chip-monitoring">
                  <mat-icon>{{ getStatusIcon(pos.status) }}</mat-icon>
                  {{ pos.status }}
                </mat-chip>
              </div>
              <div class="position-pipeline">
                <mat-icon>account_tree</mat-icon>
                {{ pos.pipeline_name }}
              </div>
              <div class="position-details" *ngIf="pos.trade_info">
                <div class="position-detail">
                  <span class="detail-label">Entry</span>
                  <span class="detail-value">
                    {{ pos.trade_info.entry_price ? ('$' + pos.trade_info.entry_price.toFixed(5)) : '-' }}
                  </span>
                </div>
                <div class="position-detail">
                  <span class="detail-label">Current</span>
                  <span class="detail-value">
                    {{ pos.trade_info.current_price ? ('$' + pos.trade_info.current_price.toFixed(5)) : '-' }}
                  </span>
                </div>
                <div class="position-detail" *ngIf="pos.trade_info.quantity">
                  <span class="detail-label">Qty</span>
                  <span class="detail-value">
                    {{ pos.trade_info.quantity }}
                  </span>
                </div>
                <div class="position-detail pnl-detail">
                  <span class="detail-label">P&L</span>
                  <span class="detail-value" [ngClass]="getPnLClass(pos.trade_info.unrealized_pl)">
                    {{ formatPnL(pos.trade_info.unrealized_pl) }}
                  </span>
                </div>
              </div>
              <div class="position-details" *ngIf="!pos.trade_info && pos.pnl">
                <div class="position-detail pnl-detail">
                  <span class="detail-label">P&L</span>
                  <span class="detail-value" [ngClass]="getPnLClass(pos.pnl.value)">
                    {{ formatPnL(pos.pnl.value) }}
                  </span>
                </div>
              </div>
              <div class="position-meta">
                <span class="meta-item">
                  <mat-icon>schedule</mat-icon>
                  {{ formatDate(pos.started_at) }}
                </span>
                <span class="meta-item" *ngIf="pos.broker">
                  <mat-icon>{{ getBrokerIcon(pos.broker.broker_name) }}</mat-icon>
                  {{ pos.broker.broker_name }}
                </span>
                <mat-chip class="mode-chip" *ngIf="pos.mode">
                  {{ pos.mode }}
                </mat-chip>
              </div>
            </div>
          </div>
          <ng-template #noPositions>
            <div class="empty-section slim">
              <mat-icon>hourglass_empty</mat-icon>
              <p>No active positions — positions appear when a pipeline enters monitoring</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <!-- ─── Section 4: Today's Performance (tile grid) ─────── -->
      <mat-card class="section-card full-width today-performance-card">
        <mat-card-header>
          <mat-card-title>
            <div class="section-title">
              <mat-icon>today</mat-icon>
              Today's Performance
            </div>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="today-tiles">
            <!-- Row 1: Always shown -->
            <div class="today-tile today-tile-large" [ngClass]="data.today.pnl >= 0 ? 'tile-tint-success' : 'tile-tint-danger'">
              <div class="today-tile-value" [ngClass]="getPnLClass(data.today.pnl)">
                {{ formatPnL(data.today.pnl) }}
              </div>
              <div class="today-tile-label">Today's P&L</div>
            </div>
            <div class="today-tile tile-tint-info">
              <div class="today-tile-value">{{ data.today.executions }}</div>
              <div class="today-tile-label">Executions</div>
            </div>
            <div class="today-tile tile-tint-accent">
              <div class="today-tile-value">{{ formatCost(data.today.cost) }}</div>
              <div class="today-tile-label">Cost</div>
            </div>
            <!-- Row 2: Shown when trades > 0 -->
            <ng-container *ngIf="data.today.total_trades > 0">
              <div class="today-tile tile-tint-info">
                <div class="today-tile-value">{{ data.today.total_trades }}</div>
                <div class="today-tile-label">Trades</div>
              </div>
              <div class="today-tile tile-tint-success">
                <div class="today-tile-value pnl-positive">{{ data.today.wins }}</div>
                <div class="today-tile-label">Wins</div>
              </div>
              <div class="today-tile tile-tint-danger">
                <div class="today-tile-value pnl-negative">{{ data.today.losses }}</div>
                <div class="today-tile-label">Losses</div>
              </div>
              <div class="today-tile tile-tint-accent">
                <div class="today-tile-value win-rate-value">
                  {{ formatPercent(data.today.win_rate * 100) }}
                </div>
                <div class="today-tile-label">Win Rate</div>
                <div class="win-loss-bar compact">
                  <div class="win-portion" [style.width.%]="data.today.win_rate * 100"></div>
                </div>
              </div>
              <div class="today-tile tile-tint-success">
                <div class="today-tile-value pnl-positive">{{ formatPnL(data.today.avg_win) }}</div>
                <div class="today-tile-label">Avg Win</div>
              </div>
              <div class="today-tile tile-tint-danger">
                <div class="today-tile-value pnl-negative">{{ formatPnL(data.today.avg_loss) }}</div>
                <div class="today-tile-label">Avg Loss</div>
              </div>
            </ng-container>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- ─── Section 5: Performance Overview ────────────────── -->

      <!-- Charts Row: Cost + P&L History -->
      <div class="charts-row">
        <!-- P&L History Chart -->
        <mat-card class="section-card chart-card">
          <mat-card-header>
            <mat-card-title>
              <div class="section-title">
                <mat-icon>show_chart</mat-icon>
                P&L History
              </div>
            </mat-card-title>
            <div class="section-actions">
              <span class="chart-period-total" [ngClass]="getPnLClass(getTotalPnLForPeriod())">
                {{ pnlChartDays }}d total: {{ formatPnL(getTotalPnLForPeriod()) }}
              </span>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="pnl-baseline-chart" *ngIf="getPnLChartData().length > 0; else noPnlData">
              <!-- Upper half: profit bars grow upward from baseline -->
              <div class="pnl-half pnl-half-upper">
                <div class="pnl-col" *ngFor="let entry of getPnLChartData()"
                     [matTooltip]="formatChartDate(entry.date) + ': ' + formatPnL(entry.pnl)">
                  <div class="pnl-bar-up"
                       *ngIf="entry.pnl > 0"
                       [style.height.%]="getPnLBarPercent(entry.pnl)">
                  </div>
                </div>
              </div>
              <!-- Baseline -->
              <div class="pnl-zero-line">
                <span class="pnl-zero-label">$0</span>
              </div>
              <!-- Lower half: loss bars grow downward from baseline -->
              <div class="pnl-half pnl-half-lower">
                <div class="pnl-col" *ngFor="let entry of getPnLChartData()"
                     [matTooltip]="formatChartDate(entry.date) + ': ' + formatPnL(entry.pnl)">
                  <div class="pnl-bar-down"
                       *ngIf="entry.pnl < 0"
                       [style.height.%]="getPnLBarPercent(entry.pnl)">
                  </div>
                </div>
              </div>
              <!-- Date labels -->
              <div class="pnl-date-labels">
                <span class="pnl-date-label" *ngFor="let entry of getPnLChartData()">
                  {{ formatShortDate(entry.date) }}
                </span>
              </div>
            </div>
            <ng-template #noPnlData>
              <div class="empty-section compact">
                <mat-icon>bar_chart</mat-icon>
                <p>No P&L data yet</p>
              </div>
            </ng-template>
          </mat-card-content>
        </mat-card>

        <!-- Cost History Chart -->
        <mat-card class="section-card chart-card">
          <mat-card-header>
            <mat-card-title>
              <div class="section-title">
                <mat-icon>attach_money</mat-icon>
                Cost History
              </div>
            </mat-card-title>
            <div class="section-actions">
              <span class="chart-period-total">
                {{ costChartDays }}d total: {{ formatCost(getTotalCostForPeriod()) }}
              </span>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="bar-chart" *ngIf="getCostChartData().length > 0; else noCostData">
              <div class="bar-chart-bars">
                <div class="bar-wrapper" *ngFor="let entry of getCostChartData()"
                     [matTooltip]="formatChartDate(entry.date) + ': ' + formatCost(entry.cost)">
                  <div class="bar cost-bar"
                       [style.height.%]="getBarHeight(entry.cost, getCostChartData(), 'cost')">
                  </div>
                  <span class="bar-label">{{ formatShortDate(entry.date) }}</span>
                </div>
              </div>
            </div>
            <ng-template #noCostData>
              <div class="empty-section compact">
                <mat-icon>bar_chart</mat-icon>
                <p>No cost data yet</p>
              </div>
            </ng-template>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Overall Trade Performance -->
      <mat-card class="section-card full-width trade-stats-card" *ngIf="data.trade_stats && data.trade_stats.total_trades > 0">
        <mat-card-header>
          <mat-card-title>
            <div class="section-title">
              <mat-icon>analytics</mat-icon>
              Overall Trade Performance
            </div>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="trade-stats-grid">
            <div class="trade-stat-item tile-tint-info">
              <div class="trade-stat-value">{{ data.trade_stats.total_trades }}</div>
              <div class="trade-stat-label">Total Trades</div>
            </div>
            <div class="trade-stat-item tile-tint-accent">
              <div class="win-rate-ring" [style.--win-deg]="(data.trade_stats.win_rate * 360) + 'deg'">
                <span class="ring-inner">{{ formatPercent(data.trade_stats.win_rate * 100) }}</span>
              </div>
              <div class="trade-stat-label">Win Rate</div>
            </div>
            <div class="trade-stat-item tile-tint-success">
              <div class="trade-stat-value pnl-positive">{{ data.trade_stats.winning_trades }}</div>
              <div class="trade-stat-label">Wins</div>
            </div>
            <div class="trade-stat-item tile-tint-danger">
              <div class="trade-stat-value pnl-negative">{{ data.trade_stats.losing_trades }}</div>
              <div class="trade-stat-label">Losses</div>
            </div>
            <div class="trade-stat-item tile-tint-success">
              <div class="trade-stat-value pnl-positive">{{ formatPnL(data.trade_stats.avg_win) }}</div>
              <div class="trade-stat-label">Avg Win</div>
            </div>
            <div class="trade-stat-item tile-tint-danger">
              <div class="trade-stat-value pnl-negative">{{ formatPnL(data.trade_stats.avg_loss) }}</div>
              <div class="trade-stat-label">Avg Loss</div>
            </div>
            <div class="trade-stat-item tile-tint-success">
              <div class="trade-stat-value pnl-positive">{{ formatPnL(data.trade_stats.best_trade) }}</div>
              <div class="trade-stat-label">Best Trade</div>
            </div>
            <div class="trade-stat-item tile-tint-danger">
              <div class="trade-stat-value pnl-negative">{{ formatPnL(data.trade_stats.worst_trade) }}</div>
              <div class="trade-stat-label">Worst Trade</div>
            </div>
            <div class="trade-stat-item tile-tint-accent">
              <div class="trade-stat-value">{{ data.trade_stats.profit_factor || '-' }}</div>
              <div class="trade-stat-label">Profit Factor</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- P&L by Pipeline -->
      <mat-card class="section-card full-width" *ngIf="data.pipeline_list.length > 0">
        <mat-card-header>
          <mat-card-title>
            <div class="section-title">
              <mat-icon>leaderboard</mat-icon>
              P&L by Pipeline
            </div>
          </mat-card-title>
          <div class="section-actions">
            <span class="chart-period-total" [ngClass]="getPnLClass(data.pnl.total_realized)">
              Total: {{ formatPnL(data.pnl.total_realized) }}
            </span>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div class="pipeline-pnl-chart" *ngIf="getPipelinePnLData().length > 0; else noPipelinePnl">
            <!-- Zero baseline label -->
            <div class="baseline-label">$0</div>
            <div class="pipeline-bars-container">
              <!-- Upper half: profit bars grow upward -->
              <div class="pipeline-bars-upper">
                <div class="pipeline-bar-col" *ngFor="let p of getPipelinePnLData()"
                     [matTooltip]="p.name + ': ' + formatPnL(p.total_pnl)"
                     (click)="viewPipeline(p)">
                  <div class="pipeline-bar pipeline-bar-profit"
                       *ngIf="p.total_pnl > 0"
                       [style.height.%]="getPipelineBarHeight(p.total_pnl)">
                    <span class="pipeline-bar-value">{{ formatPnL(p.total_pnl) }}</span>
                  </div>
                </div>
              </div>
              <!-- Baseline -->
              <div class="pipeline-baseline"></div>
              <!-- Lower half: loss bars grow downward -->
              <div class="pipeline-bars-lower">
                <div class="pipeline-bar-col" *ngFor="let p of getPipelinePnLData()"
                     [matTooltip]="p.name + ': ' + formatPnL(p.total_pnl)"
                     (click)="viewPipeline(p)">
                  <div class="pipeline-bar pipeline-bar-loss"
                       *ngIf="p.total_pnl < 0"
                       [style.height.%]="getPipelineBarHeight(p.total_pnl)">
                    <span class="pipeline-bar-value">{{ formatPnL(p.total_pnl) }}</span>
                  </div>
                </div>
              </div>
              <!-- Labels -->
              <div class="pipeline-bar-labels">
                <div class="pipeline-bar-label-col" *ngFor="let p of getPipelinePnLData()">
                  <span class="pipeline-bar-name">{{ getPipelineBarLabel(p.name) }}</span>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noPipelinePnl>
            <div class="empty-section compact">
              <mat-icon>bar_chart</mat-icon>
              <p>No pipeline P&L data yet</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <!-- ─── Section 6: Pipelines & Brokers (side-by-side) ──── -->
      <div class="pipelines-brokers-grid">

        <!-- Pipelines Table -->
        <mat-card class="section-card">
          <mat-card-header>
            <mat-card-title>
              <div class="section-title">
                <mat-icon>account_tree</mat-icon>
                Pipelines ({{ data.pipeline_list.length }})
                <span class="section-subtitle" *ngIf="data.pipelines.active > 0">
                  {{ data.pipelines.active }} active
                </span>
              </div>
            </mat-card-title>
            <div class="section-actions">
              <button mat-button (click)="goToPipelines()">View All</button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="data.pipeline_list.length > 0; else noPipelines" class="table-container">
              <table mat-table [dataSource]="data.pipeline_list" class="pipelines-table">
                <!-- Name -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Pipeline</th>
                  <td mat-cell *matCellDef="let p">
                    <div class="pipeline-name-cell">
                      <mat-icon>account_tree</mat-icon>
                      <span>{{ p.name }}</span>
                      <mat-chip class="trigger-chip" *ngIf="p.trigger_mode">
                        {{ p.trigger_mode }}
                      </mat-chip>
                    </div>
                  </td>
                </ng-container>

                <!-- Status -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let p">
                    <mat-chip [ngClass]="p.is_active ? 'pipeline-active' : 'pipeline-inactive'">
                      <mat-icon>{{ p.is_active ? 'check_circle' : 'pause_circle' }}</mat-icon>
                      {{ p.is_active ? 'Active' : 'Inactive' }}
                    </mat-chip>
                  </td>
                </ng-container>

                <!-- Broker -->
                <ng-container matColumnDef="broker">
                  <th mat-header-cell *matHeaderCellDef>Broker</th>
                  <td mat-cell *matCellDef="let p">
                    <div class="broker-cell" *ngIf="p.broker">
                      <mat-icon>{{ getBrokerIcon(p.broker.broker_name) }}</mat-icon>
                      {{ p.broker.broker_name }}
                      <span class="account-type-label" [ngClass]="getAccountTypeClass(p.broker.account_type)">
                        {{ p.broker.account_type }}
                      </span>
                    </div>
                    <span *ngIf="!p.broker" class="no-broker">-</span>
                  </td>
                </ng-container>

                <!-- Executions (total) -->
                <ng-container matColumnDef="executions">
                  <th mat-header-cell *matHeaderCellDef>Total</th>
                  <td mat-cell *matCellDef="let p">
                    <span class="exec-total">{{ p.total_executions }}</span>
                    <span class="exec-active-badge" *ngIf="p.active_executions > 0"
                          matTooltip="Currently active">
                      {{ p.active_executions }} active
                    </span>
                  </td>
                </ng-container>

                <!-- Completed -->
                <ng-container matColumnDef="completed">
                  <th mat-header-cell *matHeaderCellDef>Completed</th>
                  <td mat-cell *matCellDef="let p">
                    <span class="exec-completed-val">{{ p.completed_executions }}</span>
                  </td>
                </ng-container>

                <!-- Failed -->
                <ng-container matColumnDef="failed">
                  <th mat-header-cell *matHeaderCellDef>Failed</th>
                  <td mat-cell *matCellDef="let p">
                    <span class="exec-failed-val" [class.has-failures]="p.failed_executions > 0">
                      {{ p.failed_executions }}
                    </span>
                  </td>
                </ng-container>

                <!-- P&L -->
                <ng-container matColumnDef="pnl">
                  <th mat-header-cell *matHeaderCellDef>P&L</th>
                  <td mat-cell *matCellDef="let p">
                    <span class="pnl-value" [ngClass]="getPnLClass(p.total_pnl)">
                      {{ formatPnL(p.total_pnl) }}
                    </span>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="pipelineColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: pipelineColumns;"
                    (click)="viewPipeline(row)" class="clickable-row"></tr>
              </table>
            </div>
            <ng-template #noPipelines>
              <div class="empty-section">
                <mat-icon>add_circle_outline</mat-icon>
                <p>No pipelines created yet</p>
                <button mat-raised-button color="primary" (click)="goToPipelineBuilder()">
                  <mat-icon>add</mat-icon>
                  Create Pipeline
                </button>
              </div>
            </ng-template>
          </mat-card-content>
        </mat-card>

        <!-- Broker Accounts -->
        <mat-card class="section-card">
          <mat-card-header>
            <mat-card-title>
              <div class="section-title">
                <mat-icon>account_balance</mat-icon>
                Broker Accounts
              </div>
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="broker-list" *ngIf="data.broker_accounts.length > 0; else noBrokers">
              <div class="broker-card" *ngFor="let broker of data.broker_accounts">
                <div class="broker-header">
                  <div class="broker-identity">
                    <mat-icon [class]="'broker-icon'">{{ getBrokerIcon(broker.broker_name) }}</mat-icon>
                    <div>
                      <div class="broker-name">{{ broker.broker_name }}</div>
                      <div class="broker-account">
                        {{ getMaskedAccountId(broker.account_id) }}
                        <mat-chip class="account-type-chip"
                          [ngClass]="getAccountTypeClass(broker.account_type)">
                          {{ broker.account_type }}
                        </mat-chip>
                      </div>
                    </div>
                  </div>
                  <div class="broker-pnl" [ngClass]="getPnLClass(broker.total_pnl)">
                    {{ formatPnL(broker.total_pnl) }}
                  </div>
                </div>
                <mat-divider></mat-divider>
                <div class="broker-details">
                  <div class="broker-detail">
                    <span class="detail-label">Realized</span>
                    <span class="detail-value" [ngClass]="getPnLClass(broker.realized_pnl)">
                      {{ formatPnL(broker.realized_pnl) }}
                    </span>
                  </div>
                  <div class="broker-detail">
                    <span class="detail-label">Unrealized</span>
                    <span class="detail-value" [ngClass]="getPnLClass(broker.unrealized_pnl)">
                      {{ formatPnL(broker.unrealized_pnl) }}
                    </span>
                  </div>
                  <div class="broker-detail">
                    <span class="detail-label">Trades</span>
                    <span class="detail-value">{{ broker.total_trades }}</span>
                  </div>
                  <div class="broker-detail">
                    <span class="detail-label">Active</span>
                    <span class="detail-value">{{ broker.active_positions }}</span>
                  </div>
                  <div class="broker-detail">
                    <span class="detail-label">Pipelines</span>
                    <span class="detail-value">{{ broker.pipeline_count }}</span>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noBrokers>
              <div class="empty-section">
                <mat-icon>link_off</mat-icon>
                <p>No broker accounts configured</p>
                <p class="empty-hint">Add a broker when creating a pipeline</p>
              </div>
            </ng-template>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- ─── Section 7: Recent Activity (audit trail) ───────── -->
      <mat-card class="section-card full-width">
        <mat-card-header>
          <mat-card-title>
            <div class="section-title">
              <mat-icon>history</mat-icon>
              Recent Activity
            </div>
          </mat-card-title>
          <div class="section-actions">
            <button mat-button (click)="goToMonitoring()">View All</button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="getFilteredRecentExecutions().length > 0; else noRecent" class="table-container">
            <table mat-table [dataSource]="getFilteredRecentExecutions()" class="recent-table">
              <!-- Symbol -->
              <ng-container matColumnDef="symbol">
                <th mat-header-cell *matHeaderCellDef>Symbol</th>
                <td mat-cell *matCellDef="let e">
                  <div class="symbol-cell">{{ e.symbol || '-' }}</div>
                </td>
              </ng-container>

              <!-- Pipeline -->
              <ng-container matColumnDef="pipeline">
                <th mat-header-cell *matHeaderCellDef>Pipeline</th>
                <td mat-cell *matCellDef="let e">{{ e.pipeline_name }}</td>
              </ng-container>

              <!-- Action -->
              <ng-container matColumnDef="action">
                <th mat-header-cell *matHeaderCellDef>Action</th>
                <td mat-cell *matCellDef="let e">
                  <div class="action-cell" [ngClass]="getActionClass(e.strategy_action)">
                    <mat-icon>{{ getActionIcon(e.strategy_action) }}</mat-icon>
                    {{ e.strategy_action || 'N/A' }}
                  </div>
                </td>
              </ng-container>

              <!-- P&L -->
              <ng-container matColumnDef="pnl">
                <th mat-header-cell *matHeaderCellDef>P&L</th>
                <td mat-cell *matCellDef="let e">
                  <span *ngIf="e.pnl" class="pnl-value" [ngClass]="getPnLClass(e.pnl.value)">
                    {{ formatPnL(e.pnl.value) }}
                  </span>
                  <span *ngIf="!e.pnl">-</span>
                </td>
              </ng-container>

              <!-- Cost -->
              <ng-container matColumnDef="cost">
                <th mat-header-cell *matHeaderCellDef>Cost</th>
                <td mat-cell *matCellDef="let e">{{ formatCost(e.cost) }}</td>
              </ng-container>

              <!-- Time -->
              <ng-container matColumnDef="time">
                <th mat-header-cell *matHeaderCellDef>Time</th>
                <td mat-cell *matCellDef="let e">
                  <div class="time-cell">
                    <span>{{ formatDate(e.started_at) }}</span>
                    <span class="duration" *ngIf="e.duration_seconds">{{ formatDuration(e.duration_seconds) }}</span>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="recentColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: recentColumns;"></tr>
            </table>
          </div>
          <ng-template #noRecent>
            <div class="empty-section">
              <mat-icon>inbox</mat-icon>
              <p>No recent executions</p>
              <p class="empty-hint">Execute a pipeline to see activity here</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <!-- ─── System Status Footer ───────────────────────── -->
      <div class="system-status" *ngIf="healthStatus">
        <mat-icon class="status-healthy">check_circle</mat-icon>
        <span>Backend: {{ healthStatus.status }}</span>
        <span class="separator">·</span>
        <span>{{ healthStatus.environment }}</span>
        <span class="separator">·</span>
        <span>v{{ healthStatus.version }}</span>
      </div>
    </div>
  </div>

  <app-footer></app-footer>
</div>
