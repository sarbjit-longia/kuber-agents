<div class="execution-detail-page">
  <app-navbar></app-navbar>

  <div class="execution-detail-container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <mat-spinner diameter="60"></mat-spinner>
      <p>Loading execution details...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-container">
      <mat-icon>error</mat-icon>
      <h2>{{ error }}</h2>
      <button mat-raised-button color="primary" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back to Monitoring
      </button>
    </div>

    <!-- Execution Details -->
    <div *ngIf="execution && !loading" class="execution-content">
      <!-- Header -->
      <div class="header">
        <div class="title-section">
          <button mat-icon-button (click)="goBack()" class="back-button">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div>
            <h1>{{ execution.pipeline_name }}</h1>
            <p class="subtitle">Execution Details</p>
          </div>
        </div>
        <div class="actions">
          <button mat-raised-button color="primary" (click)="openFinalReport()">
            <mat-icon>summarize</mat-icon>
            View Final Report
          </button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-grid">
        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item">
              <span class="label">Status</span>
              <mat-chip [ngClass]="'status-' + execution.status.toLowerCase()">
                {{ execution.status }}
              </mat-chip>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item">
              <span class="label">Symbol</span>
              <span class="value">{{ execution.symbol }}</span>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item">
              <span class="label">Duration</span>
              <span class="value">{{ formatDuration(execution.duration_seconds) }}</span>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item">
              <span class="label">Cost</span>
              <span class="value">{{ formatCost(execution.cost) }}</span>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Trade Approval Section -->
      <mat-card *ngIf="isAwaitingApproval()" class="approval-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon class="approval-icon">verified_user</mat-icon>
            Trade Approval Required
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="approval-countdown-banner">
            <div class="timer-badge">
              <mat-icon>timer</mat-icon>
            </div>
            <div class="countdown-info">
              <span class="countdown-label">Auto-rejects in</span>
              <span class="countdown-value">{{ getApprovalTimeRemaining() }}</span>
            </div>
          </div>

          <div class="approval-details-grid" *ngIf="execution.result as result">
            <div class="approval-detail-section" *ngIf="result.strategy">
              <h3>Strategy Signal</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Action:</span>
                <span class="monitoring-value" [ngClass]="result.strategy.action === 'BUY' ? 'text-success' : 'text-danger'">
                  {{ result.strategy.action }}
                </span>
              </div>
              <div class="monitoring-item" *ngIf="result.strategy.confidence">
                <span class="monitoring-label">Confidence:</span>
                <span class="monitoring-value">{{ (result.strategy.confidence * 100).toFixed(0) }}%</span>
              </div>
              <div class="monitoring-item" *ngIf="result.strategy.entry_price">
                <span class="monitoring-label">Entry Price:</span>
                <span class="monitoring-value">${{ result.strategy.entry_price | number: '1.2-5' }}</span>
              </div>
              <div class="monitoring-item" *ngIf="result.strategy.stop_loss">
                <span class="monitoring-label">Stop Loss:</span>
                <span class="monitoring-value text-danger">${{ result.strategy.stop_loss | number: '1.2-5' }}</span>
              </div>
              <div class="monitoring-item" *ngIf="result.strategy.take_profit">
                <span class="monitoring-label">Take Profit:</span>
                <span class="monitoring-value text-success">${{ result.strategy.take_profit | number: '1.2-5' }}</span>
              </div>
            </div>

            <div class="approval-detail-section" *ngIf="result.risk_assessment">
              <h3>Risk Assessment</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Risk Approved:</span>
                <span class="monitoring-value" [ngClass]="result.risk_assessment.approved ? 'text-success' : 'text-danger'">
                  {{ result.risk_assessment.approved ? 'Yes' : 'No' }}
                </span>
              </div>
              <div class="monitoring-item" *ngIf="result.risk_assessment.position_size">
                <span class="monitoring-label">Position Size:</span>
                <span class="monitoring-value">{{ result.risk_assessment.position_size | number }}</span>
              </div>
              <div class="monitoring-item" *ngIf="result.risk_assessment.risk_score !== undefined">
                <span class="monitoring-label">Risk Score:</span>
                <span class="monitoring-value">{{ result.risk_assessment.risk_score }}</span>
              </div>
            </div>

            <div class="approval-detail-section" *ngIf="result.market_bias">
              <h3>Market Bias</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Direction:</span>
                <span class="monitoring-value">{{ result.market_bias.direction }}</span>
              </div>
              <div class="monitoring-item" *ngIf="result.market_bias.strength">
                <span class="monitoring-label">Strength:</span>
                <span class="monitoring-value">{{ result.market_bias.strength }}</span>
              </div>
            </div>
          </div>

          <div class="approval-actions">
            <button mat-raised-button class="approve-btn-large" (click)="approveExecution()">
              <mat-icon>check</mat-icon>
              Approve Trade
            </button>
            <button mat-raised-button class="reject-btn-large" (click)="rejectExecution()">
              <mat-icon>close</mat-icon>
              Reject Trade
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Live Position Monitoring Section -->
      <mat-card *ngIf="isMonitoring()" class="monitoring-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon class="monitoring-icon">visibility</mat-icon>
            Live Position Monitoring
          </mat-card-title>
          <div class="monitoring-actions">
            <button mat-icon-button (click)="refreshExecution()" matTooltip="Refresh">
              <mat-icon>refresh</mat-icon>
            </button>
            <button mat-raised-button color="warn" (click)="closePosition()" matTooltip="Close position immediately">
              <mat-icon>close</mat-icon>
              Close Position
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div class="monitoring-grid" *ngIf="getPositionData() as position">
            <div class="monitoring-section">
              <h3>Position Details</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Symbol:</span>
                <span class="monitoring-value">{{ position.symbol }}</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Side:</span>
                <span class="monitoring-value" [ngClass]="position.action === 'BUY' ? 'text-success' : 'text-danger'">
                  {{ position.action }}
                </span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Quantity:</span>
                <span class="monitoring-value">{{ position.qty | number }}</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Entry Price:</span>
                <span class="monitoring-value">${{ position.entryPrice | number: '1.2-5' }}</span>
              </div>
            </div>

            <div class="monitoring-section pnl-section">
              <h3>Profit & Loss</h3>
              <div class="monitoring-item pnl-item">
                <span class="monitoring-label">Unrealized P&L:</span>
                <span class="monitoring-value pnl-value" 
                      [ngClass]="position.unrealizedPl >= 0 ? 'text-success' : 'text-danger'">
                  {{ position.unrealizedPl >= 0 ? '+' : '' }}${{ position.unrealizedPl | number: '1.2-2' }}
                </span>
              </div>
              <div class="monitoring-item pnl-item">
                <span class="monitoring-label">P&L Percent:</span>
                <span class="monitoring-value pnl-percent" 
                      [ngClass]="position.pnlPercent >= 0 ? 'text-success' : 'text-danger'">
                  {{ position.pnlPercent >= 0 ? '+' : '' }}{{ position.pnlPercent | number: '1.2-2' }}%
                </span>
              </div>
            </div>

            <div class="monitoring-section">
              <h3>Risk Parameters</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Stop Loss:</span>
                <span class="monitoring-value text-danger">${{ position.stopLoss | number: '1.2-5' }}</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Take Profit:</span>
                <span class="monitoring-value text-success">${{ position.takeProfit | number: '1.2-5' }}</span>
              </div>
            </div>

            <div class="monitoring-section">
              <h3>Monitoring Status</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Check Interval:</span>
                <span class="monitoring-value">{{ formatMonitorInterval(position.monitorInterval) }}</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Next Check In:</span>
                <span class="monitoring-value countdown-value">{{ timeUntilNextCheck }}</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Final P&L Section (for completed executions) -->
      <mat-card *ngIf="hasFinalPnL()" class="final-pnl-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon class="pnl-icon">check_circle</mat-icon>
            Trade Completed - Final Results
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="monitoring-grid" *ngIf="getFinalPnL() as pnl">
            <div class="monitoring-section">
              <h3>Position Details</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Symbol:</span>
                <span class="monitoring-value">{{ pnl.symbol }}</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Side:</span>
                <span class="monitoring-value" [ngClass]="pnl.action === 'BUY' ? 'text-success' : 'text-danger'">
                  {{ pnl.action }}
                </span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Quantity:</span>
                <span class="monitoring-value">{{ pnl.qty | number }}</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Entry Price:</span>
                <span class="monitoring-value">${{ pnl.entryPrice | number: '1.2-5' }}</span>
              </div>
            </div>

            <div class="monitoring-section pnl-section">
              <h3>Final Profit & Loss</h3>
              <div class="monitoring-item pnl-item">
                <span class="monitoring-label">Final P&L:</span>
                <span class="monitoring-value pnl-value" 
                      [ngClass]="pnl.finalPnl >= 0 ? 'text-success' : 'text-danger'">
                  {{ pnl.finalPnl >= 0 ? '+' : '' }}${{ pnl.finalPnl | number: '1.2-2' }}
                </span>
              </div>
              <div class="monitoring-item pnl-item">
                <span class="monitoring-label">P&L Percent:</span>
                <span class="monitoring-value pnl-percent" 
                      [ngClass]="pnl.finalPnlPercent >= 0 ? 'text-success' : 'text-danger'">
                  {{ pnl.finalPnlPercent >= 0 ? '+' : '' }}{{ pnl.finalPnlPercent | number: '1.2-2' }}%
                </span>
              </div>
            </div>

            <div class="monitoring-section">
              <h3>Risk Parameters</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Stop Loss:</span>
                <span class="monitoring-value text-danger">${{ pnl.stopLoss | number: '1.2-5' }}</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Take Profit:</span>
                <span class="monitoring-value text-success">${{ pnl.takeProfit | number: '1.2-5' }}</span>
              </div>
            </div>

            <div class="monitoring-section">
              <h3>Completion Info</h3>
              <div class="monitoring-item">
                <span class="monitoring-label">Closed At:</span>
                <span class="monitoring-value">{{ formatDate(pnl.closedAt) }}</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Status:</span>
                <span class="monitoring-value text-success">Position Closed</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Main Content Tabs -->
      <mat-card class="content-card">
        <mat-tab-group>
          <!-- Agent Reports Tab -->
          <mat-tab label="Agent Reports">
            <div class="tab-content">
              <mat-accordion *ngIf="execution.agent_states && execution.agent_states.length > 0">
                <mat-expansion-panel *ngFor="let agent of execution.agent_states" class="agent-panel">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon [style.color]="getAgentStateColor(agent.status)">
                        {{ getAgentIcon(agent.agent_type) }}
                      </mat-icon>
                      <span>{{ agent.agent_type | titlecase }}</span>
                    </mat-panel-title>
                    <mat-panel-description>
                      <mat-chip [ngClass]="'status-' + agent.status">{{ agent.status | uppercase }}</mat-chip>
                      <span *ngIf="agent.cost > 0" class="cost-badge">${{ agent.cost.toFixed(4) }}</span>
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <div class="agent-content">
                    <!-- Agent Report Data -->
                    <div *ngIf="execution.reports && execution.reports[agent.agent_id]" class="report-section">
                      <h3>{{ execution.reports[agent.agent_id].title }}</h3>
                      <p class="summary">{{ execution.reports[agent.agent_id].summary }}</p>
                      
                      <!-- Show Chart if this is Strategy Agent -->
                      <div *ngIf="hasChart(agent)" class="chart-section">
                        <h4>Strategy Visualization</h4>
                        <app-trading-chart [chartData]="getChartData()" [height]="500"></app-trading-chart>
                      </div>

                      <!-- Report Metrics -->
                      <div *ngIf="execution.reports[agent.agent_id].metrics" class="metrics-grid">
                        <!-- If metrics is an object (key-value pairs) -->
                        <ng-container *ngIf="!isArray(execution.reports[agent.agent_id].metrics)">
                          <div *ngFor="let metric of execution.reports[agent.agent_id].metrics | keyvalue" class="metric-item">
                            <span class="metric-label">{{ metric.key }}:</span>
                            <span class="metric-value">
                              <ng-container *ngIf="isArray(metric.value); else scalarValue">
                                <ul class="metric-list">
                                  <li *ngFor="let item of $any(metric.value)">{{ item }}</li>
                                </ul>
                              </ng-container>
                              <ng-template #scalarValue>{{ metric.value }}</ng-template>
                            </span>
                          </div>
                        </ng-container>
                        
                        <!-- If metrics is an array -->
                        <ng-container *ngIf="isArray(execution.reports[agent.agent_id].metrics)">
                          <div *ngFor="let item of $any(execution.reports[agent.agent_id].metrics)" class="metric-item full-width">
                            <span class="metric-value">
                              <ng-container *ngIf="isObject(item)">
                                <pre>{{ item | json }}</pre>
                              </ng-container>
                              <ng-container *ngIf="!isObject(item)">{{ item }}</ng-container>
                            </span>
                          </div>
                        </ng-container>
                      </div>

                      <!-- Report Data -->
                      <div *ngIf="execution.reports[agent.agent_id].data" class="data-section">
                        <h4>Additional Details</h4>
                        <div *ngFor="let item of execution.reports[agent.agent_id].data | keyvalue" class="data-item">
                          <strong>{{ item.key }}:</strong>
                          <ng-container *ngIf="isArray(item.value); else dataScalar">
                            <ul class="data-list">
                              <li *ngFor="let val of $any(item.value)">{{ val }}</li>
                            </ul>
                          </ng-container>
                          <ng-template #dataScalar>
                            <!-- For numbers, display directly -->
                            <span *ngIf="isNumber(item.value)" class="formatted-content">
                              {{ item.value }}
                            </span>
                            <!-- For strings, use markdown rendering -->
                            <div *ngIf="isString(item.value)" 
                                 class="formatted-content"
                                 [innerHTML]="item.value | markdownToHtml"></div>
                            <!-- For objects, show JSON -->
                            <pre *ngIf="isObject(item.value)">{{ item.value | json }}</pre>
                          </ng-template>
                        </div>
                      </div>
                    </div>

                    <!-- Execution Timing -->
                    <div class="timing-section">
                      <div class="timing-item">
                        <mat-icon>schedule</mat-icon>
                        <span>Started: {{ formatDate(agent.started_at) }}</span>
                      </div>
                      <div class="timing-item" *ngIf="agent.completed_at">
                        <mat-icon>check_circle</mat-icon>
                        <span>Completed: {{ formatDate(agent.completed_at) }}</span>
                      </div>
                    </div>

                    <!-- Error Message -->
                    <div *ngIf="agent.error" class="error-message">
                      <mat-icon>error</mat-icon>
                      <span>{{ agent.error }}</span>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>

              <div *ngIf="!execution.agent_states || execution.agent_states.length === 0" class="empty-state">
                <mat-icon>info</mat-icon>
                <p>No agent execution data available</p>
              </div>
            </div>
          </mat-tab>

          <!-- Execution Logs Tab -->
          <mat-tab label="Execution Logs">
            <div class="tab-content logs-content">
              <div *ngIf="execution.logs && execution.logs.length > 0" class="logs-list">
                <div *ngFor="let log of execution.logs" class="log-entry" [ngClass]="'log-' + log.level">
                  <span class="log-time">{{ formatDate(log.timestamp) }}</span>
                  <span class="log-level">{{ log.level | uppercase }}</span>
                  <span class="log-agent">{{ log.agent_id }}</span>
                  <span class="log-message">{{ log.message }}</span>
                </div>
              </div>

              <div *ngIf="!execution.logs || execution.logs.length === 0" class="empty-state">
                <mat-icon>description</mat-icon>
                <p>No logs available</p>
              </div>
            </div>
          </mat-tab>

          <!-- Raw Data Tab -->
          <mat-tab label="Raw Data">
            <div class="tab-content">
              <pre class="raw-data">{{ execution | json }}</pre>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card>
    </div>
  </div>
</div>
