<div class="execution-detail-page">
  <app-navbar></app-navbar>

  <div class="execution-detail-container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <mat-spinner diameter="60"></mat-spinner>
      <p>Loading execution details...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-container">
      <mat-icon>error</mat-icon>
      <h2>{{ error }}</h2>
      <button mat-raised-button color="primary" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back to Monitoring
      </button>
    </div>

    <!-- Execution Details -->
    <div *ngIf="execution && !loading" class="execution-content">
      <!-- Header -->
      <div class="header">
        <div class="title-section">
          <button mat-icon-button (click)="goBack()" class="back-button">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div>
            <h1>{{ execution.pipeline_name }}</h1>
            <p class="subtitle">Execution Details</p>
          </div>
        </div>
        <div class="actions">
          <button mat-raised-button color="primary" (click)="openFinalReport()">
            <mat-icon>summarize</mat-icon>
            View Final Report
          </button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-grid">
        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item">
              <span class="label">Status</span>
              <mat-chip [ngClass]="'status-' + execution.status.toLowerCase()">
                {{ execution.status }}
              </mat-chip>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item">
              <span class="label">Symbol</span>
              <span class="value">{{ execution.symbol }}</span>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item">
              <span class="label">Duration</span>
              <span class="value">{{ formatDuration(execution.duration_seconds) }}</span>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item">
              <span class="label">Cost</span>
              <span class="value">{{ formatCost(execution.cost) }}</span>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Main Content Tabs -->
      <mat-card class="content-card">
        <mat-tab-group>
          <!-- Agent Reports Tab -->
          <mat-tab label="Agent Reports">
            <div class="tab-content">
              <mat-accordion *ngIf="execution.agent_states && execution.agent_states.length > 0">
                <mat-expansion-panel *ngFor="let agent of execution.agent_states" class="agent-panel">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon [style.color]="getAgentStateColor(agent.status)">
                        {{ getAgentIcon(agent.agent_type) }}
                      </mat-icon>
                      <span>{{ agent.agent_type | titlecase }}</span>
                    </mat-panel-title>
                    <mat-panel-description>
                      <mat-chip [ngClass]="'status-' + agent.status">{{ agent.status | uppercase }}</mat-chip>
                      <span *ngIf="agent.cost > 0" class="cost-badge">${{ agent.cost.toFixed(4) }}</span>
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <div class="agent-content">
                    <!-- Agent Report Data -->
                    <div *ngIf="execution.reports && execution.reports[agent.agent_id]" class="report-section">
                      <h3>{{ execution.reports[agent.agent_id].title }}</h3>
                      <p class="summary">{{ execution.reports[agent.agent_id].summary }}</p>
                      
                      <!-- Show Chart if this is Strategy Agent -->
                      <div *ngIf="hasChart(agent)" class="chart-section">
                        <h4>Strategy Visualization</h4>
                        <app-trading-chart [chartData]="getChartData()" [height]="500"></app-trading-chart>
                      </div>

                      <!-- Report Metrics -->
                      <div *ngIf="execution.reports[agent.agent_id].metrics" class="metrics-grid">
                        <!-- If metrics is an object (key-value pairs) -->
                        <ng-container *ngIf="!isArray(execution.reports[agent.agent_id].metrics)">
                          <div *ngFor="let metric of execution.reports[agent.agent_id].metrics | keyvalue" class="metric-item">
                            <span class="metric-label">{{ metric.key }}:</span>
                            <span class="metric-value">
                              <ng-container *ngIf="isArray(metric.value); else scalarValue">
                                <ul class="metric-list">
                                  <li *ngFor="let item of $any(metric.value)">{{ item }}</li>
                                </ul>
                              </ng-container>
                              <ng-template #scalarValue>{{ metric.value }}</ng-template>
                            </span>
                          </div>
                        </ng-container>
                        
                        <!-- If metrics is an array -->
                        <ng-container *ngIf="isArray(execution.reports[agent.agent_id].metrics)">
                          <div *ngFor="let item of $any(execution.reports[agent.agent_id].metrics)" class="metric-item full-width">
                            <span class="metric-value">
                              <ng-container *ngIf="isObject(item)">
                                <pre>{{ item | json }}</pre>
                              </ng-container>
                              <ng-container *ngIf="!isObject(item)">{{ item }}</ng-container>
                            </span>
                          </div>
                        </ng-container>
                      </div>

                      <!-- Report Data -->
                      <div *ngIf="execution.reports[agent.agent_id].data" class="data-section">
                        <h4>Additional Details</h4>
                        <div *ngFor="let item of execution.reports[agent.agent_id].data | keyvalue" class="data-item">
                          <strong>{{ item.key }}:</strong>
                          <ng-container *ngIf="isArray(item.value); else dataScalar">
                            <ul class="data-list">
                              <li *ngFor="let val of $any(item.value)">{{ val }}</li>
                            </ul>
                          </ng-container>
                          <ng-template #dataScalar>
                            <span *ngIf="!isObject(item.value)">{{ item.value }}</span>
                            <pre *ngIf="isObject(item.value)">{{ item.value | json }}</pre>
                          </ng-template>
                        </div>
                      </div>
                    </div>

                    <!-- Execution Timing -->
                    <div class="timing-section">
                      <div class="timing-item">
                        <mat-icon>schedule</mat-icon>
                        <span>Started: {{ formatDate(agent.started_at) }}</span>
                      </div>
                      <div class="timing-item" *ngIf="agent.completed_at">
                        <mat-icon>check_circle</mat-icon>
                        <span>Completed: {{ formatDate(agent.completed_at) }}</span>
                      </div>
                    </div>

                    <!-- Error Message -->
                    <div *ngIf="agent.error" class="error-message">
                      <mat-icon>error</mat-icon>
                      <span>{{ agent.error }}</span>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>

              <div *ngIf="!execution.agent_states || execution.agent_states.length === 0" class="empty-state">
                <mat-icon>info</mat-icon>
                <p>No agent execution data available</p>
              </div>
            </div>
          </mat-tab>

          <!-- Execution Logs Tab -->
          <mat-tab label="Execution Logs">
            <div class="tab-content logs-content">
              <div *ngIf="execution.logs && execution.logs.length > 0" class="logs-list">
                <div *ngFor="let log of execution.logs" class="log-entry" [ngClass]="'log-' + log.level">
                  <span class="log-time">{{ formatDate(log.timestamp) }}</span>
                  <span class="log-level">{{ log.level | uppercase }}</span>
                  <span class="log-agent">{{ log.agent_id }}</span>
                  <span class="log-message">{{ log.message }}</span>
                </div>
              </div>

              <div *ngIf="!execution.logs || execution.logs.length === 0" class="empty-state">
                <mat-icon>description</mat-icon>
                <p>No logs available</p>
              </div>
            </div>
          </mat-tab>

          <!-- Raw Data Tab -->
          <mat-tab label="Raw Data">
            <div class="tab-content">
              <pre class="raw-data">{{ execution | json }}</pre>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card>
    </div>
  </div>
</div>
