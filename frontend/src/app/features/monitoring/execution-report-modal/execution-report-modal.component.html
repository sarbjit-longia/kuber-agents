<div class="report-modal">
  <div class="modal-header">
    <h2>
      <mat-icon>summarize</mat-icon>
      Executive Report
    </h2>
    <button mat-icon-button (click)="close()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-divider></mat-divider>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Generating AI-powered executive summary...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <mat-icon>error</mat-icon>
    <p>{{ error }}</p>
  </div>

  <!-- Report Content -->
  <div *ngIf="executiveReport && !loading" class="modal-content">
    
    <!-- Executive Summary -->
    <div class="report-section highlight-section">
      <h3>
        <mat-icon>stars</mat-icon>
        Executive Summary
      </h3>
      <p class="summary-text">{{ executiveReport.executive_summary }}</p>
    </div>

    <mat-divider></mat-divider>

    <!-- Key Takeaways -->
    <div class="report-section" *ngIf="executiveReport.key_takeaways?.length > 0">
      <h3>
        <mat-icon>lightbulb</mat-icon>
        Key Takeaways
      </h3>
      <ul class="takeaways-list">
        <li *ngFor="let takeaway of executiveReport.key_takeaways">
          <mat-icon>check_circle</mat-icon>
          <span>{{ takeaway }}</span>
        </li>
      </ul>
    </div>

    <mat-divider></mat-divider>

    <!-- Final Recommendation -->
    <div class="report-section recommendation-section" *ngIf="executiveReport.final_recommendation">
      <h3>
        <mat-icon>flag</mat-icon>
        Final Recommendation
      </h3>
      <p class="recommendation-text">{{ executiveReport.final_recommendation }}</p>
    </div>

    <mat-divider></mat-divider>

    <!-- Charts -->
    <div class="report-section" *ngIf="hasChart()">
      <h3>
        <mat-icon>show_chart</mat-icon>
        Strategy Visualization
      </h3>
      <app-trading-chart [chartData]="getChartData()" [height]="400"></app-trading-chart>
    </div>

    <mat-divider *ngIf="hasChart()"></mat-divider>

    <!-- Detailed Agent Reports -->
    <div class="report-section">
      <h3>
        <mat-icon>psychology</mat-icon>
        Detailed Agent Analysis
      </h3>
      
      <mat-accordion *ngIf="executiveReport.agent_reports">
        <mat-expansion-panel *ngFor="let report of executiveReport.agent_reports | keyvalue" class="agent-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              {{ $any(report.value).agent_type || report.key | titlecase }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          
          <div class="agent-report-content">
            <h4>{{ $any(report.value).title }}</h4>
            <p class="agent-summary">{{ $any(report.value).summary }}</p>
            
            <!-- Chart (if available in agent report) -->
            <div *ngIf="hasAgentChart($any(report.value))" class="agent-chart-section">
              <app-trading-chart [chartData]="getAgentChartData($any(report.value))" [height]="350"></app-trading-chart>
            </div>
            
            <!-- Metrics -->
            <div *ngIf="$any(report.value).metrics" class="metrics-section">
              <div *ngFor="let metric of $any(report.value).metrics | keyvalue" class="metric-item">
                <strong>{{ metric.key }}:</strong>
                <span *ngIf="!isArray(metric.value) && !isObject(metric.value)">{{ metric.value }}</span>
                <ul *ngIf="isArray(metric.value)" class="metric-list">
                  <li *ngFor="let item of $any(metric.value)">
                    <span *ngIf="!isObject(item)">{{ item }}</span>
                    <pre *ngIf="isObject(item)" class="inline-json">{{ item | json }}</pre>
                  </li>
                </ul>
                <pre *ngIf="isObject(metric.value) && !isArray(metric.value)">{{ metric.value | json }}</pre>
              </div>
            </div>

            <!-- Additional Data -->
            <div *ngIf="$any(report.value).data" class="data-section">
              <div *ngFor="let item of $any(report.value).data | keyvalue" class="data-item">
                <strong>{{ item.key }}:</strong>
                <span *ngIf="!isArray(item.value) && !isObject(item.value)">{{ item.value }}</span>
                <ul *ngIf="isArray(item.value)" class="data-list">
                  <li *ngFor="let val of $any(item.value)">
                    <span *ngIf="!isObject(val)">{{ val }}</span>
                    <pre *ngIf="isObject(val)" class="inline-json">{{ val | json }}</pre>
                  </li>
                </ul>
                <pre *ngIf="isObject(item.value) && !isArray(item.value)">{{ item.value | json }}</pre>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <mat-divider></mat-divider>

    <!-- Risk Notes -->
    <div class="report-section" *ngIf="executiveReport.risk_notes && executiveReport.risk_notes !== 'None'">
      <h3>
        <mat-icon>warning</mat-icon>
        Risk Notes
      </h3>
      <div class="risk-notes">
        <mat-icon>info</mat-icon>
        <p>{{ executiveReport.risk_notes }}</p>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <div class="modal-footer">
    <button mat-button (click)="close()">Close</button>
    <button mat-raised-button color="primary" (click)="downloadReport()" *ngIf="executiveReport">
      <mat-icon>download</mat-icon>
      Download PDF
    </button>
  </div>
</div>
