<div class="monitoring-page">
  <app-navbar></app-navbar>

<div class="monitoring-container">
  <div class="header">
    <h1>
      <mat-icon>monitoring</mat-icon>
      Execution Monitoring
    </h1>
    <button mat-raised-button color="primary" (click)="refresh()">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
  </div>

  <!-- Active Monitoring Section (Always Visible, No Paging) - Shown First -->
  <mat-card class="active-monitoring-card" *ngIf="activeExecutions.length > 0">
    <mat-card-header>
      <mat-card-title>
        <div class="section-title">
          <mat-icon class="pulse">visibility</mat-icon>
          Active Monitoring ({{ activeExecutions.length }})
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="active-monitoring-grid">
        <div *ngFor="let execution of activeExecutions" class="active-execution-card" (click)="viewExecution(execution)">
          <!-- Header Row: Symbol + Status -->
          <div class="active-header">
            <div class="active-header-left">
              <div class="symbol-badge">{{ execution.symbol || 'N/A' }}</div>
              <span class="pipeline-label">{{ execution.pipeline_name }}</span>
            </div>
            <div class="active-header-right">
              <mat-chip class="status-chip-monitoring">
                <mat-icon>{{ getStatusIcon(execution.status) }}</mat-icon>
                {{ execution.status }}
              </mat-chip>
              <mat-chip *ngIf="execution.trade_outcome" 
                        [ngClass]="'outcome-chip-' + execution.trade_outcome"
                        class="outcome-chip-small">
                <mat-icon>{{ getOutcomeIcon(execution) }}</mat-icon>
                {{ getTradeOutcome(execution) }}
              </mat-chip>
            </div>
          </div>
          
          <!-- Key Info Row -->
          <div class="active-info-row">
            <div class="info-item">
              <span class="info-label">Mode</span>
              <mat-chip [color]="getModeColor(execution.mode)" selected class="mode-chip-small">
                {{ execution.mode }}
              </mat-chip>
            </div>
            <div class="info-item">
              <span class="info-label">Signal</span>
              <div class="result-cell-compact" [ngClass]="getResultClass(execution)">
                <mat-icon>{{ getResultIcon(execution) }}</mat-icon>
                <span>{{ getStrategyResult(execution) }}</span>
              </div>
            </div>
            <div class="info-item">
              <span class="info-label">Started</span>
              <span class="info-value">{{ formatDate(execution.started_at) }}</span>
            </div>
          </div>

          <!-- P&L Highlight -->
          <div class="active-pnl-row">
            <div class="pnl-cell-large" [ngClass]="getPnLClass(execution)">
              <span class="pnl-label">P&L</span>
              <span class="pnl-value">{{ formatPnL(execution) }}</span>
            </div>
          </div>
          
          <div class="active-actions">
            <button 
              *ngIf="isNeedsReconciliation(execution)"
              mat-raised-button 
              color="warn" 
              (click)="openReconciliationDialog(execution, $event)"
              class="reconcile-button">
              <mat-icon>warning</mat-icon>
              Reconcile
            </button>
            <button mat-raised-button color="primary" (click)="viewExecution(execution); $event.stopPropagation()">
              <mat-icon>visibility</mat-icon>
              View Details
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Execution Timeline (Music Bar Visualization) -->
  <mat-card class="timeline-card" *ngIf="executionBars.length > 0">
    <mat-card-header>
      <mat-card-title>
        <div class="section-title">
          <mat-icon>equalizer</mat-icon>
          Execution Timeline
          <span class="timeline-count">({{ filteredBars.length }} / {{ executionBars.length }})</span>
          <div class="timeline-presets">
            <button mat-stroked-button class="preset-btn" 
                    [class.active]="!allCategoriesVisible"
                    (click)="showOnlyTrades()"
                    matTooltip="Show only executed trades (profit, loss, pending)">
              <mat-icon>filter_alt</mat-icon>
              Trades Only
            </button>
            <button mat-stroked-button class="preset-btn"
                    [class.active]="allCategoriesVisible"
                    (click)="showAllCategories()"
                    matTooltip="Show all execution categories">
              <mat-icon>visibility</mat-icon>
              Show All
            </button>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="execution-timeline">
        <div class="timeline-bars-scroll">
          <div class="timeline-bars">
            <div *ngFor="let bar of filteredBars"
                 class="timeline-bar"
                 [ngClass]="bar.colorClass"
                 [style.height.px]="bar.height"
                 [matTooltip]="bar.tooltip"
                 matTooltipPosition="above"
                 (click)="onBarClick(bar.execution)">
            </div>
          </div>
        </div>
      </div>
      <div class="timeline-legend">
        <span *ngFor="let item of timelineLegend"
              class="legend-item"
              [class.legend-inactive]="!timelineFilters[item.key]"
              (click)="toggleTimelineFilter(item.key)"
              [matTooltip]="timelineFilters[item.key] ? 'Click to hide ' + item.label : 'Click to show ' + item.label">
          <mat-icon class="legend-check">{{ timelineFilters[item.key] ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
          <span class="legend-dot" [ngClass]="item.colorClass"></span>
          {{ item.label }}
          <span class="legend-count">({{ item.count }})</span>
        </span>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Filters Section -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-header">
        <h3><mat-icon>filter_list</mat-icon> Filters</h3>
        <button mat-button color="accent" (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      </div>
      
      <div class="filters-grid">
        <!-- Status Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select [(ngModel)]="filters.status" (selectionChange)="onFilterChange()">
            <mat-option *ngFor="let option of statusOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Mode Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Mode</mat-label>
          <mat-select [(ngModel)]="filters.mode" (selectionChange)="onFilterChange()">
            <mat-option *ngFor="let option of modeOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Trade Outcome Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Trade Outcome</mat-label>
          <mat-select [(ngModel)]="filters.tradeOutcome" (selectionChange)="onFilterChange()">
            <mat-option *ngFor="let option of tradeOutcomeOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Symbol Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Symbol</mat-label>
          <input matInput [(ngModel)]="filters.symbol" (ngModelChange)="onFilterChange()" placeholder="e.g. AAPL, EUR_USD">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <!-- Pipeline Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Pipeline</mat-label>
          <input matInput [(ngModel)]="filters.pipeline" (ngModelChange)="onFilterChange()" placeholder="Search pipeline name">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <!-- Start Date Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Start Date</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="filters.startDate" (dateChange)="onFilterChange()">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <!-- End Date Filter -->
        <mat-form-field appearance="outline">
          <mat-label>End Date</mat-label>
          <input matInput [matDatepicker]="endPicker" [(ngModel)]="filters.endDate" (dateChange)="onFilterChange()">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="filter-summary">
        <span class="filter-info">
          <strong>{{ historicalDataSource.data.length }}</strong> trades in table · 
          <strong>{{ activeExecutions.length }}</strong> active · 
          <strong>{{ allExecutions.length }}</strong> total executions
        </span>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Stats Cards -->
  <div class="stats-grid" *ngIf="stats">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>analytics</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-label">Total Executions</div>
          <div class="stat-value">{{ stats.total_executions }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon running">
          <mat-icon>play_circle</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-label">Active</div>
          <div class="stat-value">{{ activeExecutions.length }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon success">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-label">Success Rate</div>
          <div class="stat-value">{{ (stats.success_rate * 100).toFixed(1) }}%</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon cost">
          <mat-icon>attach_money</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-label">Total Cost</div>
          <div class="stat-value">{{ formatCost(stats.total_cost) }}</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Historical Executions Table (Paginated) -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>
        <div class="section-title">
          <mat-icon>history</mat-icon>
          Execution History
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="loading" class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Loading executions...</p>
      </div>

      <div *ngIf="!loading && historicalDataSource.data.length === 0 && activeExecutions.length === 0" class="empty-state">
        <mat-icon>inbox</mat-icon>
        <p>No executions yet</p>
        <p class="empty-hint">Execute a pipeline to see monitoring data here</p>
      </div>

      <div *ngIf="!loading && historicalDataSource.data.length > 0" class="table-container">
        <table mat-table [dataSource]="historicalDataSource" class="executions-table">
          <!-- Execution ID Column -->
          <ng-container matColumnDef="execution_id">
            <th mat-header-cell *matHeaderCellDef>Execution ID</th>
            <td mat-cell *matCellDef="let execution">
              <div class="execution-id-cell">
                <mat-icon>fingerprint</mat-icon>
                <span class="execution-id-text">{{ execution.id?.substring(0, 8) || '-' }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Symbol Column -->
          <ng-container matColumnDef="symbol">
            <th mat-header-cell *matHeaderCellDef>Symbol</th>
            <td mat-cell *matCellDef="let execution">
              <div class="symbol-cell">{{ execution.symbol || '-' }}</div>
            </td>
          </ng-container>

          <!-- Pipeline Column -->
          <ng-container matColumnDef="pipeline">
            <th mat-header-cell *matHeaderCellDef>Pipeline</th>
            <td mat-cell *matCellDef="let execution">
              <div class="pipeline-cell">
                <mat-icon>account_tree</mat-icon>
                <span>{{ execution.pipeline_name }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Mode Column -->
          <ng-container matColumnDef="mode">
            <th mat-header-cell *matHeaderCellDef>Mode</th>
            <td mat-cell *matCellDef="let execution">
              <mat-chip [color]="getModeColor(execution.mode)" selected class="mode-chip">
                {{ execution.mode | uppercase }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Source Column -->
          <ng-container matColumnDef="source">
            <th mat-header-cell *matHeaderCellDef>Source</th>
            <td mat-cell *matCellDef="let execution">{{ getSource(execution) }}</td>
          </ng-container>

          <!-- Result Column -->
          <ng-container matColumnDef="result">
            <th mat-header-cell *matHeaderCellDef>Result</th>
            <td mat-cell *matCellDef="let execution">
              <div class="result-cell" [ngClass]="getResultClass(execution)">
                <mat-icon>{{ getResultIcon(execution) }}</mat-icon>
                <span>{{ getStrategyResult(execution) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Trade Outcome Column -->
          <ng-container matColumnDef="outcome">
            <th mat-header-cell *matHeaderCellDef>Trade Outcome</th>
            <td mat-cell *matCellDef="let execution">
              <div class="outcome-cell" [ngClass]="getOutcomeClass(execution)">
                <mat-icon>{{ getOutcomeIcon(execution) }}</mat-icon>
                <span>{{ getTradeOutcome(execution) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- P&L Column -->
          <ng-container matColumnDef="pnl">
            <th mat-header-cell *matHeaderCellDef>P&L</th>
            <td mat-cell *matCellDef="let execution">
              <div class="pnl-cell" [ngClass]="getPnLClass(execution)">
                <span>{{ formatPnL(execution) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let execution">
              <mat-chip [ngClass]="'status-' + execution.status.toLowerCase()">
                <mat-icon>{{ getStatusIcon(execution.status) }}</mat-icon>
                {{ execution.status | uppercase }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Started Column -->
          <ng-container matColumnDef="started">
            <th mat-header-cell *matHeaderCellDef>Started</th>
            <td mat-cell *matCellDef="let execution">{{ formatDate(execution.started_at) }}</td>
          </ng-container>

          <!-- Duration Column -->
          <ng-container matColumnDef="duration">
            <th mat-header-cell *matHeaderCellDef>Duration</th>
            <td mat-cell *matCellDef="let execution">{{ formatDuration(execution.duration_seconds) }}</td>
          </ng-container>

          <!-- Cost Column -->
          <ng-container matColumnDef="cost">
            <th mat-header-cell *matHeaderCellDef>Cost</th>
            <td mat-cell *matCellDef="let execution">{{ formatCost(execution.total_cost) }}</td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let execution">
              <button mat-icon-button 
                      [matTooltip]="'Reconcile Trade'" 
                      color="warn"
                      *ngIf="isNeedsReconciliation(execution)"
                      (click)="openReconciliationDialog(execution, $event)">
                <mat-icon>warning</mat-icon>
              </button>
              <button mat-icon-button 
                      [matTooltip]="'View Details'" 
                      (click)="viewExecution(execution); $event.stopPropagation()">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button 
                      [matTooltip]="'View Report'" 
                      color="primary"
                      *ngIf="execution.status === 'completed' || execution.status === 'COMPLETED'"
                      (click)="viewReport(execution, $event)">
                <mat-icon>summarize</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="viewExecution(row)" class="execution-row"></tr>
        </table>

        <mat-paginator [length]="historicalTotal"
                       [pageSizeOptions]="[25, 50, 100, 200]"
                       [pageSize]="pageSize"
                       [pageIndex]="pageIndex"
                       (page)="onPageChange($event)"
                       showFirstLastButtons>
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>
</div>
